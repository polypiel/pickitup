<div>
  <h1 style="float: left;"><%= @year %> Stats</h1>

  <nav style="float: right;">
    <ul class="pagination">
      <% @years.each do |y| %>
      <% if y == @year %>
      <li class="active">
      <% else %>
      <li>
      <% end %>
        <%= link_to y, :year => y %>
      </li>
      <% end %>
    </ul>
  </nav>
</div>

<div style="clear: both;"/>

<div class="row">
  <div class="col-sm-6">
    <h2>By Pickers</h2>
    <table class="table">
      <thead>
        <tr>
          <th></th>
          <th></th>
          <th style="text-align: right;">Coins</th>
          <th style="text-align: right;">Value</th>
        </tr>
      </thead>
    <% @top_users.each_with_index do |top_user, index| %>
      <tr>
        <td><%= index + 1 %></td>
        <td><strong><%= link_to top_user['username'], user_path(top_user['id']) %></strong></td>
        <td style="text-align: right;"><%= top_user['coins'] %></td>
        <td style="text-align: right;"><%= top_user['value'] %></td>
      </tr>
    <% end %>
    </table>
  </div>

  <div class="col-sm-6">
    <h2>By Coins</h2>
    <table class="table">
      <thead>
        <tr>
          <th></th>
          <th style="text-align: right;">Pickups</th>
        </tr>
      </thead>
      <% @coins_by_type.each_with_index do |coin, index| %>
      <tr>
        <td><%= coin['coin'] %> cents</td>
        <td style="text-align: right;"><%= coin['amount'] %></td>
      </tr>
      <% end %>
    </table>
  </div>
</div>

<div class="row">
  <div class="col-sm-12">
    <h2>By Location</h2>
    <div id="map-canvas" style="height: 300px;"></div>
  </div>
</div>

<div class="row">
  <div class="col-sm-12">
    <h2>By Time</h2>
    <div id="monthly-chart" style="height: 300px;"></div>
  </div>
</div>

<div class="row">
    <div class="col-sm-6">
      <h2>By Year</h2>
      <table class="table">
        <thead>
          <tr>
            <th>Year</th>
            <th style="text-align: right;">Pickups</th>
          </tr>
        </thead>
        <% @pickups_by_year.keys.sort.reverse.each do |year| %>
        <tr>
          <td><%= year %></td>
          <td style="text-align: right;"><%= @pickups_by_year[year] %></td>
        </tr>
        <% end %>
      </table>
    </div>
</div>

<script type="text/javascript">
  $(document).ready(function() {
    // Map
    var coins = [
      <% @pickups_with_location.each { |c| %>
        {lat:<%= c.latitude %>, lon:<%= c.longitude %>},
      <% } %>
    ];

    var bounds = new google.maps.LatLngBounds();
    var map = new google.maps.Map(document.getElementById('map-canvas'), {});

    for (var i = 0; i < coins.length; i++) {
      var marker = new google.maps.Marker({
          position: new google.maps.LatLng(coins[i].lat, coins[i].lon),
          map: map
      });
      bounds.extend(marker.position);
    }
    map.fitBounds(bounds);

    // Monthly chart
    var chart = c3.generate({
      bindto: '#monthly-chart',
      data: {
        columns: [
          <% @users.each do |u| %>
            ['<%= u %>',
            <% (1..12).each do |m| %>
              <%= @pickups_by_month[u][m.to_s] || 0 %>,
            <% end %>
            ],
          <% end %>
        ],
        type: 'bar',
        groups: [
            [<%= raw @users.map {|u| "\"#{u}\""}.join "," %>]
        ]
      },
      grid: {
          y: {
              lines: [{value:0}]
          }
        }
      });
  });
</script>
