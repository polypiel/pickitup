<h1>New pickup</h1>

<%= render 'form' %>

<script>
var POSITION_TIMEOUT = 5000;

function show_map(position) {
  console.debug("Coordinates found: " + position.coords.latitude + ", " + position.coords.longitude);
  $("#location-searching").hide();
  $("#location-err").hide();

  $("#pickup_latitude").val(position.coords.latitude);
  $("#pickup_longitude").val(position.coords.longitude);
  searchLocation(position.coords.latitude, position.coords.longitude);
}

function handle_error(err) {
  console.error("Location not found: " + err);
  if ($("#pickup_latitude").val() && $("#pickup_longitude").val()) {
    return;
  }
  $("#location-searching").show();
  $("#location-err").show();

  if (err.code == 3) {
    navigator.geolocation.getCurrentPosition(show_map, handle_error, {timeout: POSITION_TIMEOUT, enableHighAccuracy: false});
  } else {
    $('#pickup_location').attr('placeholder', '');
  }
}

// Init
$(document).ready(function() {
  console.debug("init")
  $('#pickup_location').attr('placeholder', 'Searching for location...');

  // Adds datepicker if there isn't native control
  if (!isDateControlSupported()) {
    $('#pickup_picked_at_date').datepicker({format: 'dd/mm/yyyy', weekStart: 1});
  }

  // Search location 
  navigator.geolocation.getCurrentPosition(show_map, handle_error, {timeout: POSITION_TIMEOUT, enableHighAccuracy: true});
});
</script>
