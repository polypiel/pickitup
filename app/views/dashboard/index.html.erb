<div>
  <h1 style="float: left;"><%= @year %> Stats</h1>

  <nav style="float: right;">
    <ul class="pagination">
      <% @years.each do |y| %>
      <% if y == @year %>
      <li class="active">
      <% else %>
      <li>
      <% end %>
        <%= link_to y, :year => y %>
      </li>
      <% end %>
    </ul>
  </nav>
</div>

<div style="clear: both;"/>

<div class="row">
  <div class="col-sm-4 col-xs-12">
    <h2>By Pickers</h2>
    <table class="table">
      <thead>
        <tr>
          <th></th>
          <th></th>
          <th style="text-align: right;">Coins</th>
          <th style="text-align: right;">Value</th>
        </tr>
      </thead>
    <% @top_users.each_with_index do |top_user, index| %>
      <tr>
        <td><%= index + 1 %></td>
        <td><strong><%= link_to top_user['username'], user_path(top_user['id']) %></strong></td>
        <td style="text-align: right;"><%= top_user['coins'] %></td>
        <td style="text-align: right;"><%= top_user['value'] %></td>
      </tr>
    <% end %>
    </table>
  </div>

  <div class="col-sm-4 col-xs-12">
    <h2>By Coins</h2>
    <table class="table">
      <thead>
        <tr>
          <th></th>
          <th style="text-align: right;">Pickups</th>
        </tr>
      </thead>
      <% @coins_by_type.each_with_index do |coin, index| %>
      <tr>
        <td><%= coin['coin'] %> <%= coin['currency'] %></td>
        <td style="text-align: right;"><%= coin['amount'] %></td>
      </tr>
      <% end %>
    </table>
  </div>

  <div class="col-sm-4 col-xs-12">
    <h2>Last pickups</h2>
    <table class="table">
    <% @last_pickups.each do |pickup| %>
      <tr>
        <td><%= link_to pickup.coin, pickup_path(pickup) %> by <strong><%= pickup.picker.username %></strong>, <%= time_ago_in_words(pickup.picked_at) %> ago.</td>
      </tr>
    <% end %>
    <% if @last_pickups.empty? %>
      <tr><td>There isn't recent pickups. Go out and pick up some coins!</td><tr>
    <% end %>
    </table>
    <%= link_to controller: 'pickups' do %>Ver todos<% end %>
  </div>
</div>

<div class="row">
  <div class="col-sm-12">
    <h2>By Location</h2>
    <div id="map-canvas" style="height: 300px;"></div>
  </div>
</div>

<div class="row">
  <div class="col-sm-12">
    <h2>By Month</h2>
    <div id="monthly-chart" style="height: 300px;"></div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function() {
    // Map
    var coins = [
      <% @pickups_with_location.each { |c| %>
        {lat:<%= c.latitude %>, lon:<%= c.longitude %>},
      <% } %>
    ];

    var bounds = new google.maps.LatLngBounds();
    var map = new google.maps.Map(document.getElementById('map-canvas'), {
      mapTypeId: 'roadmap', 
      disableDefaultUI: true,
      zoomControl: true
    });

    for (var i = 0; i < coins.length; i++) {
      var marker = new google.maps.Marker({
          position: new google.maps.LatLng(coins[i].lat, coins[i].lon),
          map: map
      });
      bounds.extend(marker.position);
    }
    map.fitBounds(bounds);

    // Monthly chart
    c3.generate({
      bindto: '#monthly-chart',
      data: {
        x: 'x',
        columns: [
          ['x', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'a'],
          <% @users.each do |u| %>
          ['<%= u %>', <% (1..12).each do |m| %><%= @pickups_by_month[u][m.to_s] || 0 %>, <% end %>],
          <% end %>
        ],
        type: 'bar',
        groups: [
          [<%= raw @users.map {|u| "\"#{u}\""}.join "," %>]
        ]
      },
      axis: {
        x: {
          type: 'category' // this needed to load string x value
        }
      }
    });
  });
</script>
